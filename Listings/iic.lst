C51 COMPILER V9.59.0.0   IIC                                                               04/16/2021 01:57:51 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN .\Objects\iic.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Core\Src\iic.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Core\Inc) DEBUG O
                    -BJECTEXTEND PRINT(.\Listings\iic.lst) OBJECT(.\Objects\iic.obj)

line level    source

   1          /**
   2            ******************************************************************************
   3            * @file    iic.c
   4            * @author  sky-vocality(»ùÓÚPineconePi¿âº¯Êý½øÐÐÐÞ¸Ä)
   5            * @version V1.0.0
   6            * @date    20-January-2021
   7            * @brief  This file is used to Configure hardware IIC 
   8            * @License:GNU General Public License v3.0         
   9            ******************************************************************************
  10            * @attention
  11            *To operate IIC-related registers in host mode, P_SW2 = 0x80 is required. 
  12            *After  settings are completed, you must P_SW2 = 0x00
  13            *
  14            *  
  15            * 
  16            * 
  17            * 
  18            * 
  19            *
  20            * 
  21            ******************************************************************************
  22          **/
  23          /********************* The sample program is at the end of the iic.c file|Ê¾Àý³ÌÐòÔÚiic.cÎÄ¼þÄ©Î²*********
             -***************/
  24                  
  25          #include "iic.h"
  26          #include "intrins.h"
  27          /********************* IIC port|IIC¶Ë¿ÚÁ¿************************/
  28          sbit    SDA         =   P2^4;
  29          sbit    SCL         =   P2^5;
  30          /********************* IIC slave mode related variables|IIC´Ó»úÄ£Ê½Ïà¹Ø±äÁ¿************************/
  31          bit isda;                                       //Equipment Address Mark|Éè±¸µØÖ·±êÖ¾
  32          bit isma;                                       //Storage address flag|´æ´¢µØÖ·±êÖ¾
  33          unsigned char addr;
  34          unsigned char pdata buffer[256];
  35          //========================================================================
  36          // Function:void IIC_host_Slave_machine(unsigned char host_Slave_machine)|º¯Êý: void IIC_host_Slave_machin
             -e(unsigned char host_Slave_machine)
  37          // Description:Set IIC mode.|ÃèÊö: ÉèÖÃIICÄ£Ê½¡£
  38          // Parameter:Host_Slave_machine: Host mode or slave mode|²ÎÊý: host_Slave_machine£ºÖ÷»úÄ£Ê½»ò´Ó»úÄ£Ê½
  39          //       
  40          //       
  41          // Return:|·µ»Ø: 
  42          // Version:VER1.0.0|°æ±¾: VER1.0.0
  43          // Date:2018-12-20|ÈÕÆÚ: 2018-12-20
  44          // ×÷Õß: PineconePi
  45          // ±¸×¢:
  46          //      
  47          //      
  48          //      
  49          //      
  50          //      
  51          //========================================================================
  52          void IIC_host_Slave_machine(unsigned char host_Slave_machine)
C51 COMPILER V9.59.0.0   IIC                                                               04/16/2021 01:57:51 PAGE 2   

  53          {
  54   1              if(host_Slave_machine==host_machine)
  55   1              {
  56   2                      P_SW2 = 0x90;
  57   2                      I2CCFG = 0xe0;                              //Enabling I2C host mode|Ê¹ÄÜI2CÖ÷»úÄ£Ê½
  58   2          I2CMSST = 0x00;
  59   2              }
  60   1              else if(host_Slave_machine==Slave_machine)
  61   1              {
  62   2                       P_SW2 = 0x80;                          //Operating hardware IIC register must set P_SW2 to 1|²Ù×÷Ó²¼þIIC¼Ä´æÆ÷±ØÐëÖÃP_SW2Îª1
  63   2                      I2CCFG = 0x81;                              //Enabling I2C slave mode|Ê¹ÄÜI2C´Ó»úÄ£Ê½
  64   2          I2CSLADR = IIC_Slave_machine_address;       //Set the slave device address to 5A|ÉèÖÃ´Ó»úÉè±¸µØÖ·Îª5A
  65   2          I2CSLST = 0x00;
  66   2          I2CSLCR = 0x00;                             //Prohibit slave mode interruption|½ûÖ¹´Ó»úÄ£Ê½ÖÐ¶Ï
  67   2              }
  68   1              P_SW2 = 0x00;
  69   1      }
  70          //========================================================================
  71          // Function:void handle_Slave_machine()|º¯Êý: void handle_Slave_machine()
  72          // Description:IIC slave mode processing function.|ÃèÊö: IIC´Ó»úÄ£Ê½´¦Àíº¯Êý¡£
  73          // Parameter:|²ÎÊý:
  74          //       
  75          //       
  76          // Return:|·µ»Ø: 
  77          // Version:VER1.0.0|°æ±¾: VER1.0.0
  78          // Date:2018-12-20|ÈÕÆÚ: 2018-12-20
  79          // Author: Pinecone Pi|×÷Õß: PineconePi
  80          // Note:|±¸×¢:
  81          //      
  82          //      
  83          //      
  84          //      
  85          //      
  86          //========================================================================
  87          void handle_Slave_machine()
  88          {
  89   1              isda = 1;                                   //Initialization of user variables|ÓÃ»§±äÁ¿³õÊ¼»¯
  90   1          isma = 1;
  91   1          addr = 0;
  92   1          I2CTXD = buffer[addr];
  93   1          if (I2CSLST & 0x40)
  94   1          {
  95   2              I2CSLST &= ~0x40;                   //Handling START events|´¦ÀíSTARTÊÂ¼þ
  96   2          }
  97   1          else if (I2CSLST & 0x20)
  98   1          {
  99   2              I2CSLST &= ~0x20;                   //Handling RECV events|´¦ÀíRECVÊÂ¼þ
 100   2              if (isda)
 101   2              {
 102   3                  isda = 0;                       //Handling RECV events (RECV DEVICE ADDR)|´¦ÀíRECVÊÂ¼þ£¨RECV D
             -EVICE ADDR£©
 103   3              }
 104   2              else if (isma)
 105   2              {
 106   3                  isma = 0;                       //Handling RECV events (RECV MEMORY ADDR)|´¦ÀíRECVÊÂ¼þ£¨RECV M
             -EMORY ADDR£©
 107   3                  addr = I2CRXD;
 108   3                  I2CTXD = buffer[addr];
 109   3              }
 110   2              else
 111   2              {
 112   3                  buffer[addr++] = I2CRXD;        //Handling RECV events (RECV DATA)|´¦ÀíRECVÊÂ¼þ£¨RECV DATA£©
C51 COMPILER V9.59.0.0   IIC                                                               04/16/2021 01:57:51 PAGE 3   

 113   3              }
 114   2          }
 115   1          else if (I2CSLST & 0x10)
 116   1          {
 117   2              I2CSLST &= ~0x10;                   //Handling SEND events|´¦ÀíSENDÊÂ¼þ
 118   2              if (I2CSLST & 0x02)
 119   2              {
 120   3                  I2CTXD = 0xff;
 121   3              }
 122   2              else
 123   2              {
 124   3                  I2CTXD = buffer[++addr];
 125   3              }
 126   2          }
 127   1          else if (I2CSLST & 0x08)
 128   1          {
 129   2              I2CSLST &= ~0x08;                   //Handling STOP events|´¦ÀíSTOPÊÂ¼þ
 130   2              isda = 1;
 131   2              isma = 1;
 132   2          }
 133   1              
 134   1      }
 135          //========================================================================
 136          // Function:IIC Host Mode Related Processing Function|º¯Êý:  IICÖ÷»úÄ£Ê½Ïà¹Ø´¦Àíº¯Êý
 137          // Description:IIC host mode correlation processing function.|ÃèÊö:  IICÖ÷»úÄ£Ê½Ïà¹Ø´¦Àíº¯Êý¡£
 138          // Parameter:|²ÎÊý:
 139          //       
 140          //       
 141          // Return:|·µ»Ø: 
 142          // Version:VER1.0.0|°æ±¾: VER1.0.0
 143          // Date:2018-12-20|ÈÕÆÚ: 2018-12-20
 144          // Author: Pinecone Pi|×÷Õß: PineconePi
 145          // Note:|±¸×¢:
 146          //      
 147          //      
 148          //      
 149          //      
 150          //      
 151          //========================================================================
 152          void Wait()
 153          {
 154   1          while (!(I2CMSST & 0x40));
 155   1          I2CMSST &= ~0x40;
 156   1      }
 157          
 158          void Start()
 159          {
 160   1          I2CMSCR = 0x01;                             //Send START command|·¢ËÍSTARTÃüÁî
 161   1          Wait();
 162   1      }
 163          
 164          void SendData(char dat)
 165          {
 166   1          I2CTXD = dat;                               //Write data to data buffer|Ð´Êý¾Ýµ½Êý¾Ý»º³åÇø
 167   1          I2CMSCR = 0x02;                             //Send SEND command|·¢ËÍSENDÃüÁî
 168   1          Wait();
 169   1          RecvACK();
 170   1      }
 171          
 172          void RecvACK()
 173          {
 174   1          I2CMSCR = 0x03;                             //·¢ËÍ¶ÁACKÃüÁî
C51 COMPILER V9.59.0.0   IIC                                                               04/16/2021 01:57:51 PAGE 4   

 175   1          Wait();
 176   1      }
 177          
 178          unsigned char RecvData()
 179          {
 180   1          I2CMSCR = 0x04;                             //Send read ACK command|·¢ËÍRECVÃüÁî
 181   1          Wait();
 182   1          return I2CRXD;
 183   1      }
 184          
 185          void SendACK()
 186          {
 187   1          I2CMSST = 0x00;                             //Setting ACK Signal|ÉèÖÃACKÐÅºÅ
 188   1          I2CMSCR = 0x05;                             //Send ACK commands|·¢ËÍACKÃüÁî
 189   1          Wait();
 190   1      }
 191          
 192          void SendNAK()
 193          {
 194   1          I2CMSST = 0x01;                             //Setting NAK Signal|ÉèÖÃNAKÐÅºÅ
 195   1          I2CMSCR = 0x05;                             //Send ACK commands|·¢ËÍACKÃüÁî
 196   1          Wait();
 197   1      }
 198          
 199          void Stop()
 200          {
 201   1          I2CMSCR = 0x06;                             //Send STOP command|·¢ËÍSTOPÃüÁî
 202   1          Wait();
 203   1      }
 204          
 205          void wait_device()
 206          {
 207   1          int i;
 208   1      
 209   1          for (i=0; i<3000; i++)
 210   1          {
 211   2              _nop_();
 212   2              _nop_();
 213   2              _nop_();
 214   2              _nop_();
 215   2          }
 216   1      }
 217          //========================================================================
 218          // Function:IIC Host Mode Related Processing Function Example|º¯Êý:  IICÖ÷»úÄ£Ê½Ïà¹Ø´¦Àíº¯ÊýÊ¾Àý
 219          // Description: IIC host mode correlation processing function example.|ÃèÊö:  IICÖ÷»úÄ£Ê½Ïà¹Ø´¦Àíº¯ÊýÊ¾Àý¡
             -£
 220          // Parameter:|²ÎÊý:     
 221          // Return:|·µ»Ø: 
 222          // Version:VER1.0.0|°æ±¾: VER1.0.0
 223          // Date:2018-12-20|ÈÕÆÚ: 2018-12-20
 224          // Author: Pinecone Pi|×÷Õß: PineconePi
 225          // Example:|Ê¾Àý£º
 226          //    P_SW2 = 0x80;                                                                                                                                     
 227          //    IIC_host_Slave_machine£¨host_machine);       //Setting up host mode|ÉèÖÃÎªÖ÷»úÄ£Ê½
 228          //    Start();                                    //Send Start Command|·¢ËÍÆðÊ¼ÃüÁî
 229          //    SendData(0xa0);                             //Send Device Address + Write Command|·¢ËÍÉè±¸µØÖ·+Ð´ÃüÁ
             -î
 230          //    RecvACK();
 231          //    SendData(0x00);                             //Send high bytes of storage address|·¢ËÍ´æ´¢µØÖ·¸ß×Ö½Ú
 232          //    RecvACK();
 233          //    SendData(0x00);                             //Send Storage Address Low Byte|·¢ËÍ´æ´¢µØÖ·µÍ×Ö½Ú
 234          //    RecvACK();
C51 COMPILER V9.59.0.0   IIC                                                               04/16/2021 01:57:51 PAGE 5   

 235          //    SendData(0x12);                             //Write test data 1|Ð´²âÊÔÊý¾Ý1
 236          //    RecvACK();
 237          //    SendData(0x78);                             //Write test data 2|Ð´²âÊÔÊý¾Ý2
 238          //    RecvACK();
 239          //    Stop();                                     //Send stop command|·¢ËÍÍ£Ö¹ÃüÁî
 240          //    Delay();                                    //Waiting for the device to write data|µÈ´ýÉè±¸Ð´Êý¾Ý
 241          //    Start();                                    //Send Start Command|·¢ËÍÆðÊ¼ÃüÁî
 242          //    SendData(0xa0);                             //Send Device Address + Write Command|·¢ËÍÉè±¸µØÖ·+Ð´ÃüÁ
             -î
 243          //    RecvACK();
 244          //    SendData(0x00);                             //Send high bytes of storage address|·¢ËÍ´æ´¢µØÖ·¸ß×Ö½Ú
 245          //    RecvACK();
 246          //    SendData(0x00);                             //Send Storage Address Low Byte|·¢ËÍ´æ´¢µØÖ·µÍ×Ö½Ú
 247          //    RecvACK();
 248          //    Start();                                    //Send Start Command|·¢ËÍÆðÊ¼ÃüÁî
 249          //    SendData(0xa1);                             //Send device address + read command|·¢ËÍÉè±¸µØÖ·+¶ÁÃüÁî
 250          //    RecvACK();
 251          //    P0 = RecvData();                            //Read data 1|¶ÁÈ¡Êý¾Ý1
 252          //    SendACK();
 253          //    P2 = RecvData();                            //¶ÁÈ¡Êý¾Ý2|¶ÁÈ¡Êý¾Ý2
 254          //    SendNAK();
 255          //    Stop();                                     //Send stop command|·¢ËÍÍ£Ö¹ÃüÁî
 256          //    P_SW2 = 0x00;
 257          //========================================================================


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    310    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      1    ----
   PDATA SIZE       =    256    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
